services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:0.6.38
    container_name: open-webui
    restart: always
    ports:
      - "3000:8080"
    volumes:
      - open-webui-data:/app/backend/data
      - ${OPEN_WEBUI_MCP_CONFIG_PATH:-./open-webui-config/mcp}:/app/backend/data/mcp:ro
    environment:
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OPENAPI_SERVERS=http://mcp:8000
    networks:
      - webui-network
    depends_on:
      - mcp
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  ollama:
    image: ollama/ollama:0.13.0
    container_name: ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
      - ./scripts:/scripts:ro
    environment:
      - OLLAMA_MODELS=${OLLAMA_MODELS:-}
      - OLLAMA_KEEP_ALIVE=${OLLAMA_KEEP_ALIVE:-24h}
      - OLLAMA_NUM_THREADS=${OLLAMA_NUM_THREADS:-4}
      - OLLAMA_NUM_PARALLEL=${OLLAMA_NUM_PARALLEL:-1}
      - OLLAMA_MAX_LOADED_MODELS=${OLLAMA_MAX_LOADED_MODELS:-1}
    entrypoint: ["/bin/sh", "/scripts/ollama-entrypoint.sh"]
    networks:
      - webui-network
    profiles:
      - ollama

  mcp:
    build:
      context: ./mcp
      dockerfile: Dockerfile
    container_name: mcp
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://localhost:27017/food_manager}
      - MONGODB_READONLY=${MONGODB_READONLY:-false}
      - MCP_MONGODB_URI=${MONGODB_URI:-mongodb://localhost:27017/food_manager}
      - MCP_MONGODB_READONLY=${MONGODB_READONLY:-false}
    command: uvx mcpo --host 0.0.0.0 --port 8000 -- npx -y mcp-mongo-server
    networks:
      - webui-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  cloudflared:
    image: cloudflare/cloudflared:2025.11.1
    container_name: cloudflared
    restart: always
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - open-webui
    networks:
      - webui-network
    profiles:
      - cloudflared

volumes:
  open-webui-data:
  ollama-data:

networks:
  webui-network:
    driver: bridge

